const express = require("express");
const dotenv = require("dotenv");
const getUserContext = require("./getUserContext");
const askDeepseek = require("./deepseekClient");

dotenv.config();
const app = express();
app.use(express.json());

app.post("/ask", async (req, res) => {
  const { userId, question } = req.body;

  if (!userId || !question) {
    return res.status(400).json({ error: "userId Ð¸ question Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹" });
  }

  try {
    const context = getUserContext(userId);
    const messages = [
      {
        role: "system",
        content:
          "Ð¢Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð´Ð°Ñ‘Ñ‚ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.",
      },
      {
        role: "user",
        content: `Ð’Ð¾Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ:\n${context}\n\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ: ${question}`,
      },
    ];

    const answer = await askDeepseek(messages);

    if (!answer) {
      return res.status(500).json({ error: "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚" });
    }
    res.json({ answer });
  } catch (err) {
    console.error(err.message);
    res.status(500).json({ error: err.message });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° http://localhost:${PORT}`);
});
